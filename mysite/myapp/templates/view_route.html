{% extends 'base.html' %}

{% block title %}Маршрут исследования - {{ route.research.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Маршрут исследования: {{ route.research.title }}</h2>
    
    <div class="alert alert-info">
        <strong>Общее расстояние маршрута:</strong> {{ distance }} км
    </div>
    
    <div id="map" style="width: 100%; height: 500px;"></div>
    
    <a href="{% url 'research_detail' research_id=route.research.id %}" class="btn btn-primary mt-3">
        ← Вернуться к исследованию
    </a>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Преобразуем координаты в формат Leaflet [lat, lng]
            const pathCoordinates = [
                {% for coord in coordinates %}
                    [{{ coord.lat }}, {{ coord.lon }}]{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            
            // Создаем карту
            const map = L.map('map').setView(
                pathCoordinates[0] || [0, 0], 
                14
            );
            
            // Добавляем слой OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Создаем линию маршрута
            const routeLine = L.polyline(pathCoordinates, {
                color: '#1E90FF',
                weight: 4,
                opacity: 0.9,
                smoothFactor: 1
            }).addTo(map);
            
            // Добавляем маркеры
            if (pathCoordinates.length > 0) {
                L.circleMarker(pathCoordinates[0], {
                    radius: 5,
                    fillColor: "green",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup("Начало маршрута").addTo(map);
                
                L.circleMarker(pathCoordinates[pathCoordinates.length-1], {
                    radius: 5,
                    fillColor: "red",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup("Конец маршрута").addTo(map);
            }
            
            // Автомасштабирование
            if (pathCoordinates.length > 1) {
                map.fitBounds(routeLine.getBounds());
            }
            
        } catch (error) {
            console.error('Ошибка при создании карты:', error);
            document.getElementById('map').innerHTML = `
                <div class="alert alert-danger">
                    Ошибка загрузки карты: ${error.message}
                </div>
            `;
        }
    });
</script>
{% endblock %}