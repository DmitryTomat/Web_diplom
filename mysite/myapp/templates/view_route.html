{% extends 'base.html' %}

{% block title %}Маршрут исследования - {{ route.research.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Маршрут исследования: {{ route.research.title }}</h2>
    
    <div id="map" style="width: 100%; height: 500px;"></div>
    
    <a href="{% url 'research_detail' research_id=route.research.id %}" 
       class="btn btn-primary mt-3">
        ← Вернуться к исследованию
    </a>
</div>

<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key|safe }}&lang=ru_RU"></script>

<script>
    ymaps.ready(initMap);
    
    function initMap() {
        try {
            // Convert coordinates to Yandex Maps format [lon, lat]
            const points = [
                {% for coord in coordinates %}
                    [{{ coord.lon }}, {{ coord.lat }}]{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            
            // Create map centered on first point
            const map = new ymaps.Map('map', {
                center: points.length > 0 ? points[0] : [0, 0],
                zoom: 14
            });
            
            // Create route line
            const routeLine = new ymaps.Polyline(points, {
                strokeColor: "#1e88e5",
                strokeWidth: 4,
                strokeOpacity: 0.9
            });
            
            // Add line to map
            map.geoObjects.add(routeLine);
            
            // Add markers for start and end points
            if (points.length > 0) {
                const startPlacemark = new ymaps.Placemark(points[0], {
                    hintContent: 'Начало маршрута',
                    balloonContent: 'Начальная точка'
                });
                
                const endPlacemark = new ymaps.Placemark(points[points.length-1], {
                    hintContent: 'Конец маршрута',
                    balloonContent: 'Конечная точка'
                });
                
                map.geoObjects.add(startPlacemark);
                map.geoObjects.add(endPlacemark);
            }
            
            // Adjust map view to show entire route
            if (points.length > 1) {
                map.setBounds(routeLine.geometry.getBounds());
            }
            
        } catch (error) {
            console.error('Ошибка при создании карты:', error);
            document.getElementById('map').innerHTML = `
                <div class="alert alert-danger">
                    Ошибка загрузки карты: ${error.message}
                </div>
            `;
        }
    }
</script>
{% endblock %}